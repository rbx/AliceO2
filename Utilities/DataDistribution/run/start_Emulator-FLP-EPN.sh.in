#!/bin/bash

shmmonitor --cleanup

STF_BLD_INPUT_CNT=1 # must be 1 for now
EPN_CNT=3 # 0,1,2,or 3


# number of equipments (data sources) per CRU or in total in an FLP
EQUIPMENT_CNT=2

# ThroughputPer of input streams (or CRU links). Specified in Gbits / s !
# Max physical limit should ~5Gbit/s for TPC input link (~333 MB/STF/CRU)
# This works as long as DMA_CHUNK_SIZE is set to 0 (see below)
EQUIPMENT_BITS_PER_S=$((10 * 1000 * 1000 * 1000))

DATA_REGION_SIZE=$((4 * 1024 * 1024 * 1024))
SUPERPAGE_SIZE=$((2 * 1024 * 1024))

# Value 0 ignores DMA Chunk size and the whole system works with HBFrame data unit
# (estimated from the Link speed)
DMA_CHUNK_SIZE=$((0 * 1024))

chainConfig="@CMAKE_BINARY_DIR@/bin/config/readout-emu-flp-epn-chain.json"

IO_THREADS=8

READOUT="ReadoutEmulatorDevice"
READOUT+=" --transport shmem"
READOUT+=" --shm-monitor true"
READOUT+=" --mq-config $chainConfig"
READOUT+=" --data-shm-region-size $DATA_REGION_SIZE"
READOUT+=" --cru-superpage-size $SUPERPAGE_SIZE"
READOUT+=" --cru-dma-chunk-size $DMA_CHUNK_SIZE"
READOUT+=" --cru-link-count $EQUIPMENT_CNT"
READOUT+=" --cru-link-bits-per-s $EQUIPMENT_BITS_PER_S"
READOUT+=" --io-threads $IO_THREADS"

STF_BUILDER="SubTimeFrameBuilderDevice"
STF_BUILDER+=" --id stf_builder"
STF_BUILDER+=" --transport shmem"
STF_BUILDER+=" --shm-monitor true"
STF_BUILDER+=" --mq-config $chainConfig"
STF_BUILDER+=" --cru-count $STF_BLD_INPUT_CNT"
STF_BUILDER+=" --io-threads $IO_THREADS"

STF_SENDER="SubTimeFrameSenderDevice"
STF_SENDER+=" --id stf_sender"
STF_SENDER+=" --transport shmem"
STF_SENDER+=" --shm-monitor true"
STF_SENDER+=" --mq-config $chainConfig"
STF_SENDER+=" --epn-count $EPN_CNT"
STF_SENDER+=" --io-threads $IO_THREADS"

TF_BUILDER="TimeFrameBuilderDevice"
TF_BUILDER+=" --transport shmem"
TF_BUILDER+=" --shm-monitor true"
TF_BUILDER+=" --mq-config $chainConfig"
TF_BUILDER+=" --flp-count 1"
TF_BUILDER+=" --io-threads $IO_THREADS"

if [[ -z $USE_TMUX ]]; then
  # (EPN) Start TimeFrameBuilders
  if [[ $EPN_CNT -gt 0 ]]; then
    xterm -geometry 90x20+1680+0 -hold -e @CMAKE_BINARY_DIR@/bin/$TF_BUILDER --id tf_builder-0 &
  fi
  if [[ $EPN_CNT -gt 1 ]]; then
    xterm -geometry 90x20+1680+300 -hold -e @CMAKE_BINARY_DIR@/bin/$TF_BUILDER --id tf_builder-1 &
  fi
  if [[ $EPN_CNT -gt 2 ]]; then
    xterm -geometry 90x20+1680+600 -hold -e @CMAKE_BINARY_DIR@/bin/$TF_BUILDER --id tf_builder-2 &
  fi

  # (FLP) Start TimeFrameSender
  xterm -geometry 90x57+1120+0 -hold -e @CMAKE_BINARY_DIR@/bin/$STF_SENDER &

  # (FLP) Start TimeFrameBuilder
  xterm -geometry 90x57+560+0 -hold -e @CMAKE_BINARY_DIR@/bin/$STF_BUILDER &

  # (FLP) Start ReadoutEmulator
  xterm -geometry 90x57+0+0 -hold -e @CMAKE_BINARY_DIR@/bin/$READOUT --id readout-0 --cru-id 0 &

else
  # poor man's tmux environment cloning; make sure you're running tmux in control center (-CC) mode
  ENV_VAR_FILE=$(mktemp)
  typeset -gx > $ENV_VAR_FILE
  # cat $ENV_VAR_FILE

  tmux -CC \
    new-window \
    "source $ENV_VAR_FILE; @CMAKE_BINARY_DIR@/bin/$READOUT --id readout-0 --cru-id 0; read" \; \
    split-window \
    "source $ENV_VAR_FILE; @CMAKE_BINARY_DIR@/bin/$STF_BUILDER; read" \; \
    split-window  \
    "source $ENV_VAR_FILE; @CMAKE_BINARY_DIR@/bin/$STF_SENDER; read" \; \
    split-window  \
    "source $ENV_VAR_FILE; @CMAKE_BINARY_DIR@/bin/$TF_BUILDER --id tf_builder-0; read" \; \
    select-layout even-horizontal
fi
